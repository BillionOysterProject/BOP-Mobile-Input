<ion-view title="{{title}}" class="protocol-section {{sectionMeta.machineName}}">
	<ion-nav-buttons side="left">
		<!--<button menu-toggle="left" class="button button-icon icon ion-navicon"></button>-->
	</ion-nav-buttons>
	<ion-nav-buttons side="right">
		<button class="button button-clear button-positive" ng-click="showHelp(protocolMetadata.num, sectionMeta.machineName)">Help</button>
	</ion-nav-buttons>

	<ion-content class="has-header">
		<form name="sectionForm" novalidate="" ng-submit="onTapSave(sectionForm.$valid)">
			<ion-list>
				<h2 class="padding">{{sectionMeta.title}}</h2>
				<div ng-repeat="shell in section.shells track by $index"
				     class="shell"
				     ng-class="{'last':$last}">
					<div class="item item-divider">Shell {{$index + 1}} of {{section.shells.length}}</div>

					<ng-form name="totalsLiveFieldForm">
						<label class="item item-input"
						       ng-class="{ 'has-error' : totalsLiveFieldForm.totalLive.$invalid && sectionForm.$submitted}">
							<span class="input-label">Total Live Oysters</span>
							<input name="totalLive"
							       type="number"
							       ng-model="section.shells[$index].totals.live"
							       ng-change="onChangeTotalLive($index, sectionForm.$valid)"
		                           min="0"
							       required>
						</label>

						<div ng-messages="totalsLiveFieldForm.totalLive.$error"
						     class="form-errors"
						     ng-show="totalsLiveFieldForm.totalLive.$invalid && sectionForm.$submitted"
						     ng-messages-include="client/views/partials/form-errors.ng.html">
							<div class="form-error" ng-message="min">{{getMessage('notNegative')}}</div>
						</div>
						<!--<pre>{{totalsLiveFieldForm.totalLive | json}}</pre>-->
					</ng-form>

					<ng-form name="totalsDeadFieldForm">
						<label class="item item-input"
						       ng-class="{ 'has-error' : totalsDeadFieldForm.totalLive.$invalid && sectionForm.$submitted}">
							<span class="input-label">Total Dead Oysters</span>
							<input name="totalDead"
							       type="number"
							       ng-model="section.shells[$index].totals.dead"
							       ng-change="updateMainTotals(sectionForm.$valid)"
		                           min="0"
							       required>
						</label>

						<div ng-messages="totalsDeadFieldForm.totalDead.$error"
						     class="form-errors"
						     ng-show="totalsDeadFieldForm.totalDead.$invalid && sectionForm.$submitted"
						     ng-messages-include="client/views/partials/form-errors.ng.html">
							<div class="form-error" ng-message="min">{{getMessage('notNegative')}}</div>
						</div>
					</ng-form>

					<ng-form name="shellSizesForm">
						<h5 ng-if="shellHasLiveOysters($index)"
						    class="padding">Measure all LIVE oysters on shell #{{$index + 1}}</h5>
						<p ng-if="section.shells[$index].totals.live > maxLiveOysterMeasurements"
								class="padding">(Measure only {{maxLiveOysterMeasurements}} of the {{section.shells[$index].totals.live}} at random)</p>
						<div ng-repeat="oyster in getTotalLiveOystersArr($index) track by $index">
							<ng-form name="liveSizeMMFieldForm">
								<label class="item item-input"
								       ng-class="{ 'has-error' : liveSizeMMFieldForm.liveSizeMM.$invalid && sectionForm.$submitted}">
									<span class="input-label">Spat {{$index + 1}} of {{Math.min(getTotalLiveOysters($parent.$index), maxLiveOysterMeasurements)}}:</span>
									<input name="liveSizeMM"
									       type="number"
									       ng-model="section.shells[$parent.$index].liveSizesMM[$index]"
									       ng-change="updateLiveOysterStats(shellSizesForm.$valid, $parent.$index); updateMainTotals(sectionForm.$valid)"
				                           min="1"
				                           max="{{maxSpatSizeMM}}"
									       required>
									<span class="input-label">mm</span>
								</label>
								<div ng-messages="liveSizeMMFieldForm.liveSizeMM.$error"
								     class="form-errors"
								     ng-show="liveSizeMMFieldForm.liveSizeMM.$invalid && sectionForm.$submitted"
								     ng-messages-include="client/views/partials/form-errors.ng.html">
									<div class="form-error" ng-message="min">{{getMessage('notLessThanN') | tokenValues:[1]}}</div>
									<div class="form-error" ng-message="max">{{liveSizeMMFieldForm.liveSizeMM.$viewValue}}mm {{getMessage('unlikelyBig')}}</div>
								</div>
							</ng-form>

						</div>
						<div ng-show="shellHasLiveOysters($index) && shellSizesForm.$valid && getTotalLiveOysters($index) > 1"
						     class="calculated-fields">
							<h5 class="padding">Size stats for shell #{{$index + 1}}:</h5>
							<label class="item item-input">
								<span class="input-label">Min. size</span>
								<input name="min"
								       type="number"
								       ng-model="section.shells[$index].totals.sizeMM.min"
								       tabindex="-1"
								       readonly>
								<span class="input-label">mm</span>
							</label>

							<label class="item item-input">
								<span class="input-label">Max. size</span>
								<input name="max"
								       type="number"
								       ng-model="section.shells[$index].totals.sizeMM.max"
								       tabindex="-1"
								       readonly>
								<span class="input-label">mm</span>
							</label>

							<label class="item item-input">
								<span class="input-label">Avg. size</span>
								<input name="avg"
								       type="number"
								       ng-model="section.shells[$index].totals.sizeMM.avg"
								       tabindex="-1"
								       readonly>
								<span class="input-label">mm</span>
							</label>
						</div>
						<!--<pre>{{shellSizesForm | json}}</pre>-->
					</ng-form>
				</div>
				<br>
				<div ng-show="sectionForm.$valid" class="calculated-fields">
					<h5 class="padding">Population total oyster measurements</h5>
					<label class="item item-input">
						<span class="input-label">Min. size</span>
						<input name="min"
						       type="number"
						       ng-model="section.totalsMM.min"
						       tabindex="-1"
						       readonly>
						<span class="input-label">mm</span>
					</label>

					<label class="item item-input">
						<span class="input-label">Max. size</span>
						<input name="max"
						       type="number"
						       ng-model="section.totalsMM.max"
						       tabindex="-1"
						       readonly>
						<span class="input-label">mm</span>
					</label>

					<label class="item item-input">
						<span class="input-label">Avg. size</span>
						<input name="avg"
						       type="number"
						       ng-model="section.totalsMM.avg"
						       tabindex="-1"
						       readonly>
						<span class="input-label">mm</span>
					</label>
				</div>
				<div ng-show="sectionForm.$valid" class="calculated-fields">
					<h5 class="padding">Population total mortality:</h5>
					<label class="item item-input">
						<span class="input-label">Live</span>
						<input name="min"
						       type="number"
						       ng-model="section.totalsMortality.live"
						       tabindex="-1"
						       readonly>
					</label>

					<label class="item item-input">
						<span class="input-label">Dead</span>
						<input name="min"
						       type="number"
						       ng-model="section.totalsMortality.dead"
						       tabindex="-1"
						       readonly>
					</label>

				</div>

				<button class="button button-full button-calm"
				        padding="true"
				        type="submit"
				        >Save</button>
			</ion-list>
		</form>
	</ion-content>
</ion-view>